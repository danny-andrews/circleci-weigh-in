# thresh

## Separate the wheat from the chaff in your static asset bundles

A CircleCI integration for tracking file size changes across builds.

## What it Does
- Saves file containing file sizes of assets to the `$CIRCLE_ARTIFACTS/thresh/asset-sizes.json` directory as an artifact for later reference.

<details>
  <summary>Example output:</summary>

```json
{
  "public/css/app.css": 52336,
  "public/js/app.js": 408489,
  "public/js/vendor.js": 2284786
}
```
</details>

- Posts failing commit status if there are any asset size threshold failures.

  **The following only happens if a pull request is associated with the Circle build:**

- Generates diff of base branch asset sizes with current branch.

- Saves file containing that diff information to `$CIRCLE_ARTIFACTS/thresh/asset-diffs.json`.

<details>
  <summary>Example output:</summary>

```json
{
  "public/css/app.css": {
    "current": 52336,
    "original": 52336,
    "difference": 0,
    "percentChange": 0
  },
  "public/js/app.js": {
    "current": 408489,
    "original": 408489,
    "difference": 0,
    "percentChange": 0
  },
  "public/js/vendor.js": {
    "current": 3279826,
    "original": 2284786,
    "difference": 995040,
    "percentChange": 43.55
  }
}
```
</details>
<br/>

- Posts a commit status containing the diff to the sha associated with the build to give you insight into how the patch affects asset sizes.

## Comparison to Other Offerings
| | [bundlesize](https://github.com/siddharthkp/bundlesize) | [buildsize](https://buildsize.org/) | [thresh](https://github.com/danny-andrews/thresh) |
| --- | :---: | :---: | :---: |
| Handles Fingerprinting? | Y | Y | Y |
| Posts PR Status Filesize Diffs? | Y | Y | Y |
| Relies on 3rd-party service? | Y | Y | N |
| CIs Supported | Travis CI, CircleCI, Wercker, and Drone | Circle CI | Circle CI, easy to add more |
| Configuration | Expose GitHub access token to environment | None | Expose GitHub/CircleCI access token to environment |

## CLI Options

### --config-path
- Description: Filepath to your thresh conifg file.
- Type: `String`
- Default: `./.threshrc.toml`

## Configuation Values (in JSDoc Format)

- `{string} thresholds` - A list of configuration objects used to determine the conditions under which the [GitHub status](https://developer.github.com/v3/repos/statuses/#create-a-status) will be posted as "failed."
  - `{(string|string[])} thresholds.targets` - The target(s) of the threshold. Each target can be either a file path or a glob.
  - `{string} thresholds.maxSize`
- `{string} [project-name]` - The name of the project for which the asset stats will be generated. (Only use in monorepo situations where you may want to generate asset stats for multiple projects during the same build.) The asset size artifact will be scoped by project name and the CI status label (`Asset Sizes: [PROJECT_NAME]`) will be updated accordingly.

<details>
  <summary>Example config file:</summary>

```toml
[[thresholds]]
targets = "dist/app.js"
maxSize = 20000
strategy = "total"
```
This example would post a failed GitHub status if the total size of all javascript assets was larger than 20kB.
</details>

## Configuration

### [CircleCI Environment Variable Built-ins](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables)
- `CIRCLE_ARTIFACTS`<sup>[\*](#circleci-configuration)</sup>
- `CIRCLE_PROJECT_USERNAME`
- `CIRCLE_PROJECT_REPONAME`
- `CIRCLE_SHA1`
- `CI_PULL_REQUEST`
- `CIRCLE_BUILD_URL`

### Manual Environment Variables
- `GITHUB_API_TOKEN`
  - Must have read access to repository (`public_repo` scope for public repos, and `repo` scope for private repos)
  - Must have `repo:status` scope
- `CIRCLE_API_TOKEN`
  - Must have `view-builds` scope

### CircleCI Configuration
To get your artifacts uploaded to CircleCI, you need to define a [`store_artifacts`](https://circleci.com/docs/2.0/artifacts/) step which copies the files generated by thresh, and expose the directory you set as the `path` value for this step as `CIRCLE_ARTIFACTS` so thresh knows where to output the files. Example config file:

```yml
version: 2
jobs:
  build:
    # ...
    environment:
      - CIRCLE_ARTIFACTS: ./example/dist/artifacts
    steps:
      # ...
      - store_artifacts:
          # Wish I could use $CIRCLE_ARTIFACTS here :( (http://bit.ly/2vlqGiR)
          path: ./example/dist/artifacts
          destination: ./
```

## Future Plans
I've tried to keep the CI environment-agnostic code (reading config, reading asset stats, calculating asset diffs, etc.) separate from the code specific to CircleCI (reading environment variables, storing build artifacts, retrieving build info, etc.) in an effort to ease development of similar integrations for other CI environments (Jenkins, Travis, etc.).
